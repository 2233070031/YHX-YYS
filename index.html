<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我们的时光 | YHX&YYS</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
          Ubuntu, sans-serif;
      }

      :root {
        --primary-gradient: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 100%);
        --secondary-gradient: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        --text-dark: #1d1d1f;
        --text-light: #6e6e73;
        --bg-light: #f5f7fa;
      }

      body {
        background: var(--bg-light);
        color: var(--text-dark);
        line-height: 1.6;
        overflow-x: hidden;
      }

      .app-container {
        max-width: 100%;
        margin: 0 auto;
        overflow: hidden;
      }

      /* 导航栏样式 */
      nav {
        position: fixed;
        top: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 5%;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 1000;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        cursor: pointer;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        text-decoration: none;
        color: var(--text-light);
        font-size: 1rem;
        font-weight: 500;
        transition: color 0.3s;
        cursor: pointer;
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: #ff9a9e;
      }

      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-light);
        cursor: pointer;
      }

      /* 页面内容区域 */
      .page {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        min-height: 100vh;
        padding: 80px 5% 40px;
        width: 100%;
      }

      .page.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }

      /* 主标题区域 */
      .hero {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 0 5%;
        position: relative;
        overflow: hidden;
      }

      .hero h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 15px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeUp 1s ease forwards 0.5s;
      }

      .hero p {
        font-size: 1.1rem;
        color: var(--text-light);
        max-width: 100%;
        margin-bottom: 30px;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeUp 1s ease forwards 0.8s;
        padding: 0 5%;
      }

      .heart-btn {
        background: var(--primary-gradient);
        border: none;
        padding: 12px 30px;
        border-radius: 30px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeUp 1s ease forwards 1.1s;
      }

      .heart-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
      }

      /* 相册区域 */
      .gallery-title {
        text-align: center;
        margin-bottom: 40px;
      }

      .gallery-title h2 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 15px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .gallery-title p {
        font-size: 1rem;
        color: var(--text-light);
        max-width: 100%;
        margin: 0 auto;
        padding: 0 5%;
      }

      .gallery-filters {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 30px;
      }

      .filter-btn {
        background: white;
        border: 1px solid #e0e0e0;
        padding: 8px 16px;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
      }

      .filter-btn.active,
      .filter-btn:hover {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
      }

      .photos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        width: 100%;
      }

      .photo {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        position: relative;
        height: 220px;
        background: var(--secondary-gradient);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .photo:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.3s;
      }

      .photo-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        color: white;
        transform: translateY(100%);
        transition: transform 0.3s;
      }

      .photo:hover .photo-info {
        transform: translateY(0);
      }

      /* 删除按钮 */
      .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 5;
      }

      .photo:hover .delete-btn {
        opacity: 1;
      }

      .delete-btn:hover {
        background: rgba(255, 77, 77, 0.9);
        color: white;
      }

      /* 上传按钮样式 */
      .upload-section {
        text-align: center;
        margin: 40px 0;
      }

      .upload-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .upload-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
      }

      /* 上传模态框 */
      .upload-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .upload-modal.active {
        display: flex;
      }

      .upload-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .upload-modal h3 {
        margin-bottom: 20px;
        text-align: center;
        color: #ff9a9e;
        font-size: 1.5rem;
      }

      .upload-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group label {
        font-weight: 500;
        color: var(--text-dark);
      }

      .form-group select,
      .form-group input {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
      }

      /* 美化文件选择按钮 */
      .file-input-container {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }

      .file-input-button {
        background: var(--secondary-gradient);
        color: var(--text-dark);
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
        border: 1px dashed #a1c4fd;
      }

      .file-input-button:hover {
        background: linear-gradient(135deg, #91b9fc 0%, #b0e0fa 100%);
        transform: translateY(-2px);
      }

      .file-input {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-name {
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--text-light);
        text-align: center;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 10px;
      }

      .cancel-btn {
        background: #f1f1f1;
        color: var(--text-dark);
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }

      .cancel-btn:hover {
        background: #e5e5e5;
      }

      .submit-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
      }

      /* 照片查看模态框 */
      .viewer-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .viewer-modal.active {
        display: flex;
      }

      .viewer-content {
        width: 70%;
        max-width: 900px;
        height: 70%;
        background: #1d1d1f;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .viewer-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .viewer-video {
        max-width: 100%;
        max-height: 100%;
      }

      .viewer-nav {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        transform: translateY(-50%);
        z-index: 10;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 1.5rem;
        transition: background 0.3s;
        z-index: 10;
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .viewer-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 30px;
        cursor: pointer;
        z-index: 10;
      }

      .viewer-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        text-align: center;
      }

      .viewer-info h3 {
        margin-bottom: 5px;
        font-size: 1.2rem;
      }

      .viewer-info p {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      /* 成功提示 */
      .success-toast {
        position: fixed;
        top: 100px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 3000;
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      .success-toast.show {
        transform: translateX(0);
      }

      /* 确认删除模态框 */
      .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .confirm-modal.active {
        display: flex;
      }

      .confirm-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .confirm-modal h3 {
        margin-bottom: 20px;
        color: var(--text-dark);
      }

      .confirm-modal p {
        margin-bottom: 25px;
        color: var(--text-light);
      }

      .confirm-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
      }

      .confirm-cancel {
        background: #f1f1f1;
        color: var(--text-dark);
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 500;
      }

      .confirm-delete {
        background: #ff4757;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
      }

      /* 时间线区域 */
      .timeline-title {
        text-align: center;
        margin-bottom: 40px;
      }

      .timeline-title h2 {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 15px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .timeline-container {
        position: relative;
        max-width: 100%;
        margin: 0 auto;
      }

      .timeline-container::after {
        content: '';
        position: absolute;
        width: 6px;
        background: var(--primary-gradient);
        top: 0;
        bottom: 0;
        left: 50%;
        margin-left: -3px;
        border-radius: 10px;
      }

      .timeline-item {
        padding: 10px 30px;
        position: relative;
        width: 50%;
        opacity: 0;
        transform: translateY(50px);
      }

      .timeline-item:nth-child(odd) {
        left: 0;
        text-align: right;
      }

      .timeline-item:nth-child(even) {
        left: 50%;
      }

      .timeline-content {
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .timeline-date {
        font-weight: 700;
        color: #ff9a9e;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .timeline-content h3 {
        margin-bottom: 10px;
        font-size: 1.2rem;
        color: var(--text-dark);
      }

      .timeline-content p {
        font-size: 0.95rem;
        color: var(--text-light);
      }

      /* 纪念日区域 */
      .anniversaries {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 40px;
      }

      .anniversary-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .anniversary-card h3 {
        margin-bottom: 15px;
        color: #ff9a9e;
        font-size: 1.2rem;
      }

      .countdown {
        font-size: 1.8rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 15px 0;
      }

      .anniversary-card p {
        font-size: 0.95rem;
        color: var(--text-light);
      }

      /* 故事区域 */
      .story-content {
        max-width: 100%;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .story-section {
        margin-bottom: 30px;
      }

      .story-section h3 {
        margin-bottom: 15px;
        color: #ff9a9e;
        font-size: 1.3rem;
      }

      .story-section p {
        font-size: 1rem;
        color: var(--text-dark);
        line-height: 1.7;
        margin-bottom: 15px;
      }

      /* 页脚 */
      footer {
        text-align: center;
        padding: 30px 5%;
        background: #1d1d1f;
        color: #86868b;
      }

      footer p {
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .footer-heart {
        color: #ff9a9e;
        animation: heartbeat 1.5s infinite;
        display: inline-block;
      }

      /* 加载动画 */
      .loader {
        display: inline-block;
        width: 80px;
        height: 80px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
      }
      .loader:after {
        content: ' ';
        display: block;
        width: 64px;
        height: 64px;
        margin: 8px;
        border-radius: 50%;
        border: 6px solid #ff9a9e;
        border-color: #ff9a9e transparent #ff9a9e transparent;
        animation: loader 1.2s linear infinite;
      }

      /* 动画 */
      @keyframes fadeUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes heartbeat {
        0% {
          transform: scale(1);
        }
        5% {
          transform: scale(1.2);
        }
        10% {
          transform: scale(1.1);
        }
        15% {
          transform: scale(1.3);
        }
        50% {
          transform: scale(1);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes loader {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .nav-links {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100vh;
          background: white;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 30px;
          z-index: 999;
        }

        .nav-links.active {
          display: flex;
        }

        .nav-links a {
          font-size: 1.2rem;
        }

        .mobile-menu-btn {
          display: block;
          z-index: 1000;
        }

        .hero h1 {
          font-size: 2rem;
        }

        .hero p {
          font-size: 0.95rem;
        }

        .heart-btn {
          padding: 10px 25px;
          font-size: 0.95rem;
        }

        .gallery-title h2,
        .timeline-title h2 {
          font-size: 1.8rem;
        }

        .photos {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .photo {
          height: 180px;
        }

        .viewer-content {
          width: 90%;
          height: 50%;
        }

        .nav-btn {
          width: 40px;
          height: 40px;
          font-size: 1.2rem;
        }

        .timeline-item {
          width: 100%;
          padding-left: 50px;
          padding-right: 0;
          left: 0 !important;
          text-align: left !important;
        }

        .timeline-container::after {
          left: 20px;
        }
      }

      /* 新增优化样式 */

      /* 懒加载图片样式 */
      .lazy-load {
        opacity: 0;
        transition: opacity 0.3s;
      }

      .lazy-load.loaded {
        opacity: 1;
      }

      /* 加载更多按钮 */
      .load-more {
        text-align: center;
        margin: 30px 0;
      }

      .load-more-btn {
        background: var(--secondary-gradient);
        border: none;
        padding: 12px 30px;
        border-radius: 30px;
        color: var(--text-dark);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .load-more-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(161, 196, 253, 0.3);
      }

      /* 骨架屏加载效果 */
      .photo-skeleton {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        height: 220px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* 图片压缩预览样式 */
      .blur-load {
        filter: blur(10px);
        transition: filter 0.3s;
      }

      .blur-load.loaded {
        filter: blur(0);
      }

      /* 缓存指示器 */
      .cache-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- 导航栏 -->
      <nav>
        <div class="logo" data-page="home">Our Moments</div>
        <div class="nav-links">
          <a class="active" data-page="home">首页</a>
          <a data-page="gallery">相册</a>
          <a data-page="timeline">时间线</a>
          <a data-page="story">故事</a>
          <a data-page="anniversary">纪念日</a>
        </div>
        <button class="mobile-menu-btn" id="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </button>
      </nav>

      <!-- 首页 -->
      <div id="home" class="page active">
        <section class="hero">
          <h1>我们的浪漫时光</h1>
          <p>记录每一刻心动，珍藏每一份美好</p>
          <button class="heart-btn" data-page="gallery">
            <i class="fas fa-heart"></i> 开启回忆
          </button>
        </section>
      </div>

      <!-- 相册页面 -->
      <div id="gallery" class="page">
        <div class="gallery-title">
          <h2>美好瞬间</h2>
          <p>我们一起走过的日子，都是最美的风景</p>
        </div>

        <div class="upload-section">
          <button class="upload-btn" id="upload-btn">
            <i class="fas fa-cloud-upload-alt"></i> 上传照片/视频
          </button>
        </div>

        <div class="gallery-filters">
          <button class="filter-btn active" data-filter="all">全部</button>
          <button class="filter-btn" data-filter="travel">旅行</button>
          <button class="filter-btn" data-filter="celebration">庆祝</button>
          <button class="filter-btn" data-filter="daily">日常</button>
        </div>

        <div class="photos" id="photos-container">
          <!-- 照片将通过JS动态添加 -->
          <div class="loading-text">正在加载照片...</div>
        </div>

        <div class="load-more">
          <button class="load-more-btn" id="load-more-btn" style="display: none">加载更多</button>
        </div>
      </div>

      <!-- 时间线页面 -->
      <div id="timeline" class="page">
        <div class="timeline-title">
          <h2>我们的故事</h2>
          <p>时间会流逝，但我们的爱永恒</p>
        </div>

        <div class="timeline-container">
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">2020年5月20日</div>
              <h3>初次相遇</h3>
              <p>在那家熟悉的咖啡馆，我们的故事开始了。你穿着蓝色连衣裙，笑容如阳光般灿烂。</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">2020年8月15日</div>
              <h3>第一次旅行</h3>
              <p>我们去了海边，手牵手走在沙滩上，看夕阳西下，许下永恒的承诺。</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">2021年3月12日</div>
              <h3>你的生日</h3>
              <p>为你准备了惊喜派对，你感动得落泪，那一刻我知道我要让你永远幸福。</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">2021-12-24</div>
              <h3>圣诞之夜</h3>
              <p>我们一起装饰圣诞树，在炉火旁交换礼物，那是我们最温暖的圣诞节。</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">2022-05-20</div>
              <h3>两周年纪念</h3>
              <p>两年的时间让我们的爱更加深厚，我们决定一起打造未来的家。</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 故事页面 -->
      <div id="story" class="page">
        <div class="gallery-title">
          <h2>我们的爱情故事</h2>
          <p>从相遇的那一刻起，我们的故事就开始了</p>
        </div>

        <div class="story-content">
          <div class="story-section">
            <h3>初遇</h3>
            <p>
              那是一个阳光明媚的下午，在街角的咖啡店，我不小心撞到了你，咖啡洒在了你的白衬衫上。我慌乱地道歉，你却笑着说："没关系，这可能是命运想让我们认识的方式。"
            </p>
            <p>你的笑容像阳光一样温暖，那一刻，我知道 something special 开始了。</p>
          </div>

          <div class="story-section">
            <h3>第一次约会</h3>
            <p>
              我们在一家小小的意大利餐厅共进晚餐，聊了整整四个小时，直到餐厅打烊。我发现我们喜欢同样的电影、同样的书籍，甚至同样奇怪的披萨配料——菠萝。
            </p>
            <p>分别时，你在我脸颊上轻轻一吻，那晚我失眠了。</p>
          </div>

          <div class="story-section">
            <h3>重要的时刻</h3>
            <p>
              记得那次爬山，突然下起了大雨，我们浑身湿透，却大笑着跑下山。在亭子里躲雨时，你看着我，认真地说："我希望以后的每一天都能和你一起度过。"
            </p>
            <p>那是我听过最动人的情话。</p>
          </div>
        </div>
      </div>

      <!-- 纪念日页面 -->
      <div id="anniversary" class="page">
        <div class="gallery-title">
          <h2>重要纪念日</h2>
          <p>生命中那些值得纪念的特殊日子</p>
        </div>

        <div class="anniversaries">
          <div class="anniversary-card">
            <h3>相遇纪念日</h3>
            <p>2024年5月26日</p>
            <div class="countdown" id="meet-countdown">0天</div>
            <p>我们已经相识 <span id="meet-days">1135</span> 天</p>
          </div>

          <div class="anniversary-card">
            <h3>恋爱纪念日</h3>
            <p>2024年6月01日</p>
            <div class="countdown" id="love-countdown">0天</div>
            <p>我们已经相爱 <span id="love-days">1048</span> 天</p>
          </div>

          <div class="anniversary-card">
            <h3>下一个纪念日</h3>
            <p>下一个5月20日</p>
            <div class="countdown" id="next-countdown">0天</div>
            <p>准备一份特别的礼物吧</p>
          </div>
        </div>
      </div>

      <!-- 上传模态框 -->
      <div class="upload-modal" id="upload-modal">
        <div class="upload-modal-content">
          <h3>上传照片/视频</h3>
          <form class="upload-form" id="upload-form">
            <div class="form-group">
              <label for="media-category">选择分类</label>
              <select id="media-category" required>
                <option value="travel">旅行</option>
                <option value="celebration">庆祝</option>
                <option value="daily">日常</option>
                <option value="other">其他</option>
              </select>
            </div>
            <div class="form-group">
              <label for="media-title">标题</label>
              <input type="text" id="media-title" placeholder="请输入标题" required />
            </div>
            <div class="form-group">
              <label for="media-date">日期</label>
              <input type="date" id="media-date" required />
            </div>
            <div class="form-group">
              <label for="media-file">选择文件</label>
              <div class="file-input-container">
                <div class="file-input-button">
                  <i class="fas fa-file-upload"></i> 选择照片或视频
                </div>
                <input
                  type="file"
                  id="media-file"
                  class="file-input"
                  accept="image/*,video/*"
                  required
                />
              </div>
              <div class="file-name" id="file-name">未选择文件</div>
            </div>
            <div class="form-actions">
              <button type="button" class="cancel-btn" id="cancel-upload">取消</button>
              <button type="submit" class="submit-btn">上传</button>
            </div>
          </form>
        </div>
      </div>

      <!-- 照片查看模态框 -->
      <div class="viewer-modal" id="viewer-modal">
        <div class="viewer-content">
          <div class="viewer-nav">
            <div class="nav-btn prev-btn" id="prev-btn">
              <i class="fas fa-chevron-left"></i>
            </div>
            <div class="nav-btn next-btn" id="next-btn">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
          <div class="viewer-close" id="viewer-close">
            <i class="fas fa-times"></i>
          </div>
          <img class="viewer-image" id="viewer-image" src="" alt="" style="display: none" />
          <video class="viewer-video" id="viewer-video" controls style="display: none"></video>
          <div class="viewer-info">
            <h3 id="viewer-title"></h3>
            <p id="viewer-date"></p>
          </div>
        </div>
      </div>

      <!-- 确认删除模态框 -->
      <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-modal-content">
          <h3>确认删除</h3>
          <p>您确定要删除这张照片吗？此操作无法撤销。</p>
          <div class="confirm-actions">
            <button class="confirm-cancel" id="confirm-cancel">取消</button>
            <button class="confirm-delete" id="confirm-delete">确认删除</button>
          </div>
        </div>
      </div>

      <!-- 成功提示 -->
      <div class="success-toast" id="success-toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">操作成功</span>
      </div>

      <!-- 加载动画 -->
      <div class="loader" id="loader" style="display: none"></div>

      <!-- 缓存指示器 -->
      <div class="cache-indicator" id="cache-indicator">使用缓存数据</div>

      <!-- 页脚 -->
      <footer>
        <p>
          Made with <span class="footer-heart"><i class="fas fa-heart"></i></span> for our
          everlasting love
        </p>
        <p>© 2024 Our Moments. All rights reserved.</p>
      </footer>
    </div>

    <script>
      // Supabase初始化
      const SUPABASE_URL = 'https://uhgdfaulrykmakygxibj.supabase.co'
      const SUPABASE_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoZ2RmYXVscnlrbWFreWd4aWJqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjAwODA1MiwiZXhwIjoyMDcxNTg0MDUyfQ.2O6u4E23dg1o_6FpjpB8DIYAE7HCkBrcpfE3EtlR9mk'

      // 初始化Supabase客户端
      let supabase
      let currentPage = 1
      const itemsPerPage = 12 // 每页加载12个项目
      let isLoading = false
      let hasMore = true

      // 数据缓存
      const mediaCache = {
        data: [],
        timestamp: 0,
        expiry: 5 * 60 * 1000 // 5分钟缓存
      }

      function initSupabase() {
        try {
          if (window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            console.log('Supabase客户端初始化成功')
            return true
          } else {
            throw new Error('Supabase未加载')
          }
        } catch (error) {
          console.error('Supabase初始化失败:', error)
          return false
        }
      }

      // 确保 Supabase 加载完成后再初始化
      function waitForSupabase() {
        if (!initSupabase()) {
          setTimeout(waitForSupabase, 100)
        }
      }

      // 开始等待 Supabase 加载
      waitForSupabase()

      // 页面加载完成后执行
      document.addEventListener('DOMContentLoaded', function () {
        // 移动端菜单按钮
        const mobileMenuBtn = document.getElementById('mobile-menu-btn')
        const navLinks = document.querySelector('.nav-links')

        mobileMenuBtn.addEventListener('click', function () {
          navLinks.classList.toggle('active')

          // 切换菜单图标
          const icon = mobileMenuBtn.querySelector('i')
          if (navLinks.classList.contains('active')) {
            icon.classList.remove('fa-bars')
            icon.classList.add('fa-times')
          } else {
            icon.classList.remove('fa-times')
            icon.classList.add('fa-bars')
          }
        })

        // 导航链接点击事件
        const navLinksAll = document.querySelectorAll('.nav-links a, .logo, .heart-btn')
        navLinksAll.forEach((link) => {
          link.addEventListener('click', function () {
            const pageId = this.getAttribute('data-page')
            if (pageId) {
              switchPage(pageId)

              // 在移动端点击后关闭菜单
              if (window.innerWidth <= 768) {
                navLinks.classList.remove('active')
                mobileMenuBtn.querySelector('i').classList.remove('fa-times')
                mobileMenuBtn.querySelector('i').classList.add('fa-bars')
              }
            }
          })
        })

        // 切换页面函数
        function switchPage(pageId) {
          // 隐藏所有页面
          document.querySelectorAll('.page').forEach((page) => {
            page.classList.remove('active')
          })

          // 显示目标页面
          document.getElementById(pageId).classList.add('active')

          // 更新导航激活状态
          document.querySelectorAll('.nav-links a').forEach((link) => {
            link.classList.remove('active')
            if (link.getAttribute('data-page') === pageId) {
              link.classList.add('active')
            }
          })

          // 滚动到顶部
          window.scrollTo(0, 0)

          // 如果是时间线页面，初始化时间线动画
          if (pageId === 'timeline') {
            initTimelineAnimation()
          }

          // 如果是纪念日页面，初始化倒计时
          if (pageId === 'anniversary') {
            initCountdowns()
          }

          // 如果是相册页面，从Supabase加载照片
          if (pageId === 'gallery') {
            loadPhotosFromSupabase()
          }
        }

        // 相册筛选功能
        const filterButtons = document.querySelectorAll('.filter-btn')
        filterButtons.forEach((button) => {
          button.addEventListener('click', function () {
            // 更新按钮激活状态
            filterButtons.forEach((btn) => btn.classList.remove('active'))
            this.classList.add('active')

            const filter = this.getAttribute('data-filter')
            currentFilter = filter

            // 筛选照片
            renderPhotos()
          })
        })

        // 初始化时间线动画
        function initTimelineAnimation() {
          const timelineItems = document.querySelectorAll('.timeline-item')

          timelineItems.forEach((item, index) => {
            item.style.opacity = 0
            item.style.transform = 'translateY(50px)'
            item.style.transition = 'opacity 0.5s, transform 0.5s'

            setTimeout(() => {
              item.style.opacity = 1
              item.style.transform = 'translateY(0)'
            }, 200 * index)
          })
        }

        // 初始化纪念日倒计时
        function initCountdowns() {
          // 相遇纪念日（示例：2020年5月20日）
          const meetDate = new Date('2024-05-26')
          updateCountdown(meetDate, 'meet-countdown', 'meet-days')

          // 恋爱纪念日（示例：2020年8月15日）
          const loveDate = new Date('2024-06-01')
          updateCountdown(loveDate, 'love-countdown', 'love-days')

          // 下一个5月20日
          const nextDate = getNextAnniversary()
          updateCountdown(nextDate, 'next-countdown')
        }

        function updateCountdown(targetDate, countdownId, daysId = null) {
          const now = new Date()
          const timeDiff = targetDate - now
          const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24))

          if (daysDiff > 0) {
            document.getElementById(countdownId).textContent = `${daysDiff}天`
          } else if (daysDiff === 0) {
            document.getElementById(countdownId).textContent = '就是今天！'
          } else {
            // 如果已经过去，计算过去的天数
            const daysPassed = Math.abs(daysDiff)
            if (daysId) {
              document.getElementById(daysId).textContent = daysPassed
            }
            document.getElementById(countdownId).textContent = '已过去 ' + daysPassed + ' 天'
          }
        }

        function getNextAnniversary() {
          const now = new Date()
          const currentYear = now.getFullYear()
          const nextDate = new Date(currentYear, 4, 20) // 5月20日（月份从0开始）

          // 如果今年的纪念日已经过去，计算明年的
          if (now > nextDate) {
            nextDate.setFullYear(currentYear + 1)
          }

          return nextDate
        }

        // 显示成功提示
        function showSuccessToast(message) {
          const toast = document.getElementById('success-toast')
          const toastMessage = document.getElementById('toast-message')

          toastMessage.textContent = message
          toast.classList.add('show')

          setTimeout(() => {
            toast.classList.remove('show')
          }, 3000)
        }

        // 显示/隐藏加载动画
        function showLoader(show) {
          const loader = document.getElementById('loader')
          loader.style.display = show ? 'block' : 'none'
        }

        // 显示缓存指示器
        function showCacheIndicator() {
          const indicator = document.getElementById('cache-indicator')
          indicator.style.display = 'block'

          setTimeout(() => {
            indicator.style.display = 'none'
          }, 2000)
        }

        // 初始化页面
        initTimelineAnimation()
        initCountdowns()

        // 上传功能
        const uploadBtn = document.getElementById('upload-btn')
        const uploadModal = document.getElementById('upload-modal')
        const cancelUpload = document.getElementById('cancel-upload')
        const uploadForm = document.getElementById('upload-form')
        const photosContainer = document.getElementById('photos-container')
        const mediaFileInput = document.getElementById('media-file')
        const fileNameDisplay = document.getElementById('file-name')

        // 删除功能相关
        const confirmModal = document.getElementById('confirm-modal')
        const confirmCancel = document.getElementById('confirm-cancel')
        const confirmDelete = document.getElementById('confirm-delete')
        let mediaToDelete = null

        // 文件选择美化
        mediaFileInput.addEventListener('change', function () {
          if (this.files.length > 0) {
            fileNameDisplay.textContent = this.files[0].name
          } else {
            fileNameDisplay.textContent = '未选择文件'
          }
        })

        // 存储所有媒体文件
        let mediaItems = []
        let currentMediaIndex = 0
        let currentFilter = 'all'
        let currentMediaArray = []

        // 从Supabase加载照片 - 优化版本
        async function loadPhotosFromSupabase(page = 1, reset = false) {
          if (isLoading) return

          showLoader(true)
          isLoading = true

          // 检查缓存是否有效
          const now = Date.now()
          if (!reset && mediaCache.timestamp && now - mediaCache.timestamp < mediaCache.expiry) {
            // 使用缓存数据
            mediaItems = mediaCache.data
            renderPhotos()
            isLoading = false
            showLoader(false)
            showCacheIndicator()
            return
          }

          try {
            // 检查supabase是否已初始化
            if (!supabase) {
              console.error('Supabase客户端未初始化')
              showSuccessToast('加载照片失败，请刷新重试')
              return
            }

            // 计算分页
            const from = (page - 1) * itemsPerPage
            const to = from + itemsPerPage - 1

            // 只请求需要的字段
            const { data, error, count } = await supabase
              .from('OurPic')
              .select('id, pic_type, pic_title, pic_date, pic', { count: 'exact' })
              .order('pic_date', { ascending: false })
              .range(from, to)

            if (error) {
              console.error('Error loading photos:', error)
              showSuccessToast('加载照片失败，请刷新重试')
              return
            }

            // 检查是否还有更多数据
            hasMore = to < count

            // 更新加载更多按钮
            const loadMoreBtn = document.getElementById('load-more-btn')
            if (loadMoreBtn) {
              if (hasMore) {
                loadMoreBtn.style.display = 'block'
              } else {
                loadMoreBtn.style.display = 'none'
              }
            }

            // 转换数据格式以匹配应用
            if (reset || page === 1) {
              mediaItems = data.map(convertMediaItem)
            } else {
              mediaItems = [...mediaItems, ...data.map(convertMediaItem)]
            }

            // 更新缓存
            mediaCache.data = mediaItems
            mediaCache.timestamp = Date.now()

            renderPhotos()
          } catch (err) {
            console.error('Unexpected error:', err)
            showSuccessToast('加载照片失败，请刷新重试')
          } finally {
            isLoading = false
            showLoader(false)
          }
        }

        // 转换数据项格式
        function convertMediaItem(item) {
          return {
            id: item.id,
            category: item.pic_type,
            title: item.pic_title,
            date: item.pic_date,
            type: 'image',
            url: item.pic,
            // 添加低分辨率预览图（使用Base64缩略图或模糊处理）
            thumbnail: createThumbnail(item.pic)
          }
        }

        // 创建缩略图（简化版，实际应用中应在服务器端生成）
        function createThumbnail(base64String) {
          // 这里简化处理，实际应该使用canvas生成缩略图
          // 或者服务器端提供缩略图功能
          return base64String // 实际应用中返回缩略图URL
        }

        // 初始化相册
        function initGallery() {
          currentPage = 1
          loadPhotosFromSupabase(currentPage, true)

          // 添加加载更多按钮事件
          const loadMoreBtn = document.getElementById('load-more-btn')
          if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', () => {
              currentPage++
              loadPhotosFromSupabase(currentPage, false)
            })
          }
        }

        // 渲染照片 - 优化版本
        function renderPhotos() {
          // 清空容器，除非是加载更多
          if (currentPage === 1) {
            photosContainer.innerHTML = ''
          }

          if (mediaItems.length === 0 && currentPage === 1) {
            photosContainer.innerHTML =
              '<div class="loading-text">暂无照片，请上传您的第一张照片</div>'
            return
          }

          currentMediaArray =
            currentFilter === 'all'
              ? mediaItems
              : mediaItems.filter((item) => item.category === currentFilter)

          if (currentMediaArray.length === 0 && currentPage === 1) {
            photosContainer.innerHTML = '<div class="loading-text">该分类下暂无照片</div>'
            return
          }

          // 使用DocumentFragment提高DOM操作性能
          const fragment = document.createDocumentFragment()

          currentMediaArray
            .slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage)
            .forEach((media, index) => {
              const photoElement = createPhotoElement(media, index)
              fragment.appendChild(photoElement)
            })

          photosContainer.appendChild(fragment)

          // 初始化懒加载
          initLazyLoad()
        }

        // 创建照片元素
        function createPhotoElement(media, index) {
          const photoElement = document.createElement('div')
          photoElement.className = 'photo'
          photoElement.setAttribute('data-category', media.category)
          photoElement.setAttribute('data-id', media.id)

          // 使用骨架屏或模糊效果占位
          if (media.type === 'image') {
            photoElement.innerHTML = `
              <img class="lazy-load blur-load" 
                   data-src="${media.url}" 
                   src="${media.thumbnail}" 
                   alt="${media.title}" 
                   loading="lazy">
              <button class="delete-btn" data-id="${media.id}">
                  <i class="fas fa-trash"></i>
              </button>
              <div class="photo-info">
                  <h3>${media.title}</h3>
                  <p>${formatDate(media.date)}</p>
              </div>
            `
          } else if (media.type === 'video') {
            photoElement.innerHTML = `
              <video class="lazy-load" data-src="${media.url}" poster="${media.thumbnail}"></video>
              <button class="delete-btn" data-id="${media.id}">
                  <i class="fas fa-trash"></i>
              </button>
              <div class="photo-info">
                  <h3>${media.title}</h3>
                  <p>${formatDate(media.date)}</p>
              </div>
            `
          }

          // 添加事件监听
          photoElement.addEventListener('click', (e) => {
            if (!e.target.closest('.delete-btn')) {
              // 计算全局索引
              const globalIndex = mediaItems.findIndex((item) => item.id === media.id)
              openViewer(globalIndex)
            }
          })

          // 添加删除按钮事件
          const deleteBtn = photoElement.querySelector('.delete-btn')
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            const mediaId = parseInt(deleteBtn.getAttribute('data-id'))
            showDeleteConfirm(mediaId)
          })

          return photoElement
        }

        // 初始化懒加载
        function initLazyLoad() {
          const lazyImages = document.querySelectorAll('.lazy-load')

          if ('IntersectionObserver' in window) {
            const lazyImageObserver = new IntersectionObserver((entries, observer) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  const lazyImage = entry.target

                  if (lazyImage.tagName === 'IMG') {
                    lazyImage.src = lazyImage.dataset.src
                  } else if (lazyImage.tagName === 'VIDEO') {
                    lazyImage.src = lazyImage.dataset.src
                  }

                  lazyImage.classList.add('loaded')
                  lazyImageObserver.unobserve(lazyImage)
                }
              })
            })

            lazyImages.forEach((lazyImage) => {
              lazyImageObserver.observe(lazyImage)
            })
          } else {
            // 不支持IntersectionObserver的回退方案
            lazyImages.forEach((lazyImage) => {
              if (lazyImage.tagName === 'IMG') {
                lazyImage.src = lazyImage.dataset.src
              } else if (lazyImage.tagName === 'VIDEO') {
                lazyImage.src = lazyImage.dataset.src
              }
              lazyImage.classList.add('loaded')
            })
          }
        }

        // 显示删除确认对话框
        function showDeleteConfirm(mediaId) {
          mediaToDelete = mediaId
          confirmModal.classList.add('active')
        }

        // 执行删除操作
        async function deleteMedia() {
          if (mediaToDelete) {
            showLoader(true)
            try {
              // 检查supabase是否已初始化
              if (!supabase) {
                console.error('Supabase客户端未初始化')
                showSuccessToast('删除失败，请刷新重试')
                return
              }

              const { error } = await supabase.from('OurPic').delete().eq('id', mediaToDelete)

              if (error) {
                console.error('Error deleting media:', error)
                showSuccessToast('删除失败，请重试')
                return
              }

              // 从本地数组中移除
              mediaItems = mediaItems.filter((item) => item.id !== mediaToDelete)
              // 使缓存失效
              mediaCache.timestamp = 0
              renderPhotos()
              showSuccessToast('照片已成功删除')
            } catch (err) {
              console.error('Unexpected error:', err)
              showSuccessToast('删除失败，请重试')
            } finally {
              showLoader(false)
              mediaToDelete = null
              confirmModal.classList.remove('active')
            }
          }
        }

        // 打开查看器
        function openViewer(index) {
          const viewerModal = document.getElementById('viewer-modal')
          const viewerImage = document.getElementById('viewer-image')
          const viewerVideo = document.getElementById('viewer-video')
          const viewerTitle = document.getElementById('viewer-title')
          const viewerDate = document.getElementById('viewer-date')

          currentMediaIndex = index
          const media = currentMediaArray[index]

          if (media.type === 'image') {
            viewerImage.style.display = 'block'
            viewerVideo.style.display = 'none'
            viewerImage.src = media.url
            viewerImage.alt = media.title
          } else if (media.type === 'video') {
            viewerImage.style.display = 'none'
            viewerVideo.style.display = 'block'
            viewerVideo.src = media.url
          }

          viewerTitle.textContent = media.title
          viewerDate.textContent = formatDate(media.date)

          viewerModal.classList.add('active')
        }

        // 关闭查看器
        function closeViewer() {
          const viewerModal = document.getElementById('viewer-modal')
          const viewerVideo = document.getElementById('viewer-video')

          viewerModal.classList.remove('active')
          if (viewerVideo) viewerVideo.pause()
        }

        // 导航到上一个/下一个媒体
        function navigateMedia(direction) {
          currentMediaIndex += direction

          if (currentMediaIndex < 0) {
            currentMediaIndex = currentMediaArray.length - 1
          } else if (currentMediaIndex >= currentMediaArray.length) {
            currentMediaIndex = 0
          }

          const media = currentMediaArray[currentMediaIndex]
          const viewerImage = document.getElementById('viewer-image')
          const viewerVideo = document.getElementById('viewer-video')
          const viewerTitle = document.getElementById('viewer-title')
          const viewerDate = document.getElementById('viewer-date')

          if (media.type === 'image') {
            viewerImage.style.display = 'block'
            viewerVideo.style.display = 'none'
            viewerImage.src = media.url
            viewerImage.alt = media.title
          } else if (media.type === 'video') {
            viewerImage.style.display = 'none'
            viewerVideo.style.display = 'block'
            viewerVideo.src = media.url
          }

          viewerTitle.textContent = media.title
          viewerDate.textContent = formatDate(media.date)
        }

        // 格式化日期
        function formatDate(dateString) {
          const date = new Date(dateString)
          return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`
        }

        // 打开上传模态框
        uploadBtn.addEventListener('click', () => {
          uploadModal.classList.add('active')
          document.getElementById('media-date').valueAsDate = new Date()
        })

        // 关闭上传模态框
        cancelUpload.addEventListener('click', () => {
          uploadModal.classList.remove('active')
          uploadForm.reset()
          fileNameDisplay.textContent = '未选择文件'
        })

        // 提交上传表单
        uploadForm.addEventListener('submit', async (e) => {
          e.preventDefault()

          const category = document.getElementById('media-category').value
          const title = document.getElementById('media-title').value
          const date = document.getElementById('media-date').value
          const fileInput = document.getElementById('media-file')
          const file = fileInput.files[0]

          if (file) {
            showLoader(true)
            try {
              // 检查supabase是否已初始化
              if (!supabase) {
                console.error('Supabase客户端未初始化')
                showSuccessToast('上传失败，请刷新重试')
                return
              }

              // 将文件转换为Base64
              const reader = new FileReader()
              reader.onload = async function (e) {
                try {
                  // 插入数据到Supabase
                  const { data, error } = await supabase
                    .from('OurPic')
                    .insert([
                      {
                        pic_type: category,
                        pic_title: title,
                        pic_date: date,
                        pic: e.target.result
                      }
                    ])
                    .select()

                  if (error) {
                    console.error('Error uploading media:', error)
                    showSuccessToast('上传失败，请重试')
                    return
                  }

                  // 添加到本地数组开头
                  const newMedia = {
                    id: data[0].id,
                    category: category,
                    title: title,
                    date: date,
                    type: file.type.startsWith('image') ? 'image' : 'video',
                    url: e.target.result,
                    thumbnail: e.target.result // 简化处理
                  }

                  mediaItems.unshift(newMedia)

                  // 使缓存失效
                  mediaCache.timestamp = 0

                  // 重新渲染
                  currentPage = 1
                  renderPhotos()

                  uploadModal.classList.remove('active')
                  uploadForm.reset()
                  fileNameDisplay.textContent = '未选择文件'

                  showSuccessToast('照片上传成功！')
                } catch (err) {
                  console.error('Unexpected error:', err)
                  showSuccessToast('上传失败，请重试')
                } finally {
                  showLoader(false)
                }
              }
              reader.readAsDataURL(file)
            } catch (err) {
              console.error('Unexpected error:', err)
              showSuccessToast('上传失败，请重试')
              showLoader(false)
            }
          }
        })

        // 删除确认事件
        confirmCancel.addEventListener('click', () => {
          confirmModal.classList.remove('active')
          mediaToDelete = null
        })

        confirmDelete.addEventListener('click', deleteMedia)

        // 查看器事件监听
        document.getElementById('viewer-close').addEventListener('click', closeViewer)
        document.getElementById('prev-btn').addEventListener('click', () => {
          navigateMedia(-1)
        })
        document.getElementById('next-btn').addEventListener('click', () => {
          navigateMedia(1)
        })

        // 点击模态框外部关闭
        window.addEventListener('click', (e) => {
          if (e.target === uploadModal) {
            uploadModal.classList.remove('active')
            uploadForm.reset()
            fileNameDisplay.textContent = '未选择文件'
          }

          if (e.target === document.getElementById('viewer-modal')) {
            closeViewer()
          }

          if (e.target === confirmModal) {
            confirmModal.classList.remove('active')
            mediaToDelete = null
          }
        })

        // 初始化相册
        initGallery()

        // 窗口调整大小时重新计算布局
        window.addEventListener('resize', function () {
          // 重新初始化时间线（针对屏幕方向变化）
          if (document.getElementById('timeline').classList.contains('active')) {
            initTimelineAnimation()
          }
        })

        // 添加滚动加载更多功能
        let scrollTimeout
        window.addEventListener('scroll', () => {
          clearTimeout(scrollTimeout)
          scrollTimeout = setTimeout(() => {
            if (isLoading || !hasMore) return

            const scrollPosition = window.scrollY + window.innerHeight
            const pageHeight = document.documentElement.scrollHeight
            const threshold = 200 // 距离底部200px时加载

            if (scrollPosition > pageHeight - threshold) {
              currentPage++
              loadPhotosFromSupabase(currentPage, false)
            }
          }, 100)
        })
      })
    </script>
  </body>
</html>
